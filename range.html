
<!DOCTYPE html>
<html>
   <head>
   <meta charset="utf-8">
      <title>Electric Car Range</title>
    </head>
	<script src="https://d3js.org/d3.v4.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <body style = "font-family:verdana;font-size:20px;" id = "tooltipBody">
		<div class="right" style="padding-left:20px;position:relative;font-size:36px;">
		
		    <p>
			 You want your electric car to have...
		    </p>
		</div>
    
	<a href="https://maxahoy.github.io/electricVehicleCompare2021/performance.html";onClick="currentChart = performanceButton();console.log('chartchoice = ' + currentChart);" style="cursor: pointer; cursor: hand; font-size:20px;color:blue;" title="Click me to see the Performance chart">. . . the best Performance</a><br>
	<a style="font-size:20px;color:black;" title = "Click me to see the Range chart">. . .  the longest Range</a><br>
	<a href="https://maxahoy.github.io/electricVehicleCompare2021/charging.html";onClick="currentChart = chargingButton();console.log('chartchoice = ' + currentChart);" style="cursor: pointer; cursor: hand; font-size:20px;color:blue;" title = "Click me to see the Charging chart">  . . . the fastest Charging</a><br>
	<p></p>
	<p>Sort by either battery size or energy consumption.</p>
	
	<select id="rangeSelect" title="Select your battery metric">
		<option value="usable_battery_size">Usable Battery Size</option>
		<option value="energy_consumption.average_consumption">Average Energy Consumption</option>
	

<output></output>
    </select>
	<p><p>
	
		<svg id="range" width = "2000" height="450">
		</svg>
	<div id="tooltipDiv" style = "font-size:16px;"></div>	
		<script>
	
	
		/*
	##TODO:
Import the json data - done
Build the scatter plot
In the update loop as well
No transitions necessary... but maybe if you feel like it


	*/
	//for development url: https://raw.githack.com/Maxahoy/electricVehicleCompare2021/main/ev-data.json
		//for production: https://rawcdn.githack.com/Maxahoy/electricVehicleCompare2021/d20daec3b06eec3013a8fec48acae39e6c528447/ev-data.json
	var dataURL = "https://rawcdn.githack.com/Maxahoy/electricVehicleCompare2021/d20daec3b06eec3013a8fec48acae39e6c528447/ev-data.json"

	var margin = {top : 20, right: 100, bottom: 90, left: 100},
		width = 1000 - margin.left - margin.right,
		height = 450 - margin.top - margin.bottom;
	
	//select the svg for this page	
	var rangeSVG = d3.select("#range")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
	//tooltip (TODO)
	
	//x axis
	/*var x = d3.scaleL()
		.range([0, width])
		.padding(0.03);
	var xAxis = rangeSVG.append("g")  //copied from the performance one...
		.attr("transform", "translate(0," + height + ")")*/
		
		


		
	var tooltip = d3.select("#tooltipDiv")
				.append("div")
				.attr("class", "tooltip")
				.style("background-color", "white")
				.style("border", "solid")
				.style("border-width", "1px")
				.style("border-radius", "5px")
				.style("padding", "10px")
	
	function clearChart() {
		//just draw a big white rectangle over the entire SVG?
		rangeSVG.selectAll("dot").remove();
		rangeSVG.append("rect")
		.attr("x", -100)
		.attr("y", -100)
		.attr("width", 1000)
		.attr("height", 1000)
		.attr("fill", "white");
	}
	var x = d3.scaleLinear()
			.range([0, width]);
	var xAxis = rangeSVG.append("g")
		.attr("class", "X_axis");
	
	//y axis
	var y = d3.scaleLinear()
		.range([height, 0]);
	var yAxis = rangeSVG.append("g")
		.attr("class", "Y_axis");
	//update method; input is going to be based on a slider in km
	function updateRangeChart(batteryMetric) {		
		
	x = d3.scaleLinear()
		.range([0, width]);
	xAxis = rangeSVG.append("g")
		.attr("class", "X_axis");

	y = d3.scaleLinear()
		.range([height, 0]);	
		
	yAxis = rangeSVG.append("g")
		.attr("class", "Y_axis");
		
		d3.json(dataURL, function(data) {
			//console.log(data);
			/*
				The json contains several layers
				
				First, there's the 293 vehicles in the "data" array read in from the json
				
				Also the 40 BRANDS in the "brands" array read in from the json
				
				there's also a "meta" array which just contains an update data and a count of vehicles in the dataset
			*/
			let brands = []
			for (let i = 0; i < data.brands.length; i++) {
				brands.push(data.brands[i].name)
			}
			
			var color = d3.scaleOrdinal().domain(brands)
				.range(d3.schemeSet3);
			
			let vehicles = []
			for (let i = 0; i < data.data.length; i++) {
				range = data.data[i].usable_battery_size * (100 / data.data[i].energy_consumption.average_consumption)
				
				
				if (range > 50 && range < 990)
				{
					vehicles.push(data.data[i])
				}

			}
			
			
			//was hoping to highlight all of a certain color upon being clicked... no luck
			var onClick = function(d) {
				d3.selectAll("." + d.brand)
					//.transition()
					//.duration(200)
					.style("opacity", 1)
				console.log("onclick")
			}
				
			var mouseOver = function(d) {
				tooltip.style("opacity", 1)
				//console.log("mouseover")
			}
			
			var mouseMove = function(d) {
				range = d.usable_battery_size * (100 / d.energy_consumption.average_consumption)
				range = Math.round(range * 1) / 1
				//console.log("mousemove")
				tooltip.style("opacity", 1)
				.style("left", (d3.mouse(this)[0])+"px")
				.style("top", (d3.mouse(this)[1]) + "px")
				.html("<strong>Make:</strong> <span style='color:red'>" + (d.brand).split("_")[0] 
				
				+ "</span><br><strong>Model: </strong> <span style='color:red'>" + d.model	
				+ "</span><br><strong>Trim: </strong> <span style='color:red'>" + d.variant
				+ "</span><br><strong>Estimated Range (km): </strong> <span style='color:red'>" + range
				+ "</span><br><strong>Estimated Range (mi): </strong> <span style='color:red'>" + Math.round((range/1.609))/1
				+ "</span><br><strong>Usable Battery Size (kwH) </strong> <span style='color:red'>" + d.usable_battery_size
				+ "</span><br><strong>Energy Consumption / 100km </strong> <span style='color:red'>" + d.energy_consumption.average_consumption
)
			}
			
			var mouseLeave = function(d) {
				tooltip.transition()
				.duration(100)
				.style("opacity", 0)
				//console.log("mouseleave")
			}
			
			//console.log("minusable " + minUsableBattery) //5.5
			//console.log("maxusable " + maxUsableBattery) //200
			//console.log("minavg " + minAvgEnergy) //4.5
			//console.log("maxavg " + maxAvgEnergy) //197
		
			
			//get the max of the selected battery metric
			maxBatteryMetric = 0
			for (let i = 0; i < vehicles.length; i++) {
				
				if ("energy_consumption.average_consumption".match(batteryMetric))
				{
					metric = vehicles[i]['energy_consumption']['average_consumption']
				}
				else
				{
					metric = vehicles[i][batteryMetric]
				}
				
				if (metric > maxBatteryMetric && maxBatteryMetric < 200)
				{
					maxBatteryMetric = metric
				}
				
				
			}

			x.domain([0, maxBatteryMetric]);
			xAxis//.transition().duration(500)
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x));
			//TODO: give axis label

			y.domain([0, 600])
			yAxis//.transition().duration(500)
			.call(d3.axisLeft(y));
			

				
			/*
				This draws the vehicle points that I actually want to look at
			*/
			rangeSVG.append("g")
				.selectAll("dot")
				.data(vehicles)
				.enter()
				.append("circle")//.transition().duration(500)
				.on("mousemove", mouseMove)
				//.on("mouseleave", mouseLeave)
				.on("mouseover", mouseOver)
				//.on("click", onClick)
								.attr("cx", function(d) {
											xScaleInput = 0
											if ("energy_consumption.average_consumption".match(batteryMetric))
												{
													xScaleInput = d['energy_consumption']['average_consumption']
												}
											else {
												xScaleInput = d['usable_battery_size']
											
											}
											return x(xScaleInput); 
										})
				.attr("cy", function(d) {return y(d.usable_battery_size * (100 / d.energy_consumption.average_consumption));})
				.attr("r", 7)
				.style("fill", function (d) {return color(d.brand);})
				.style("opacity", .5)
				.style("stroke", "white")
				
		
			
		
		})
	
	}
	
	d3.select("#rangeSelect").on("change", function() {
		var selectedOption = d3.select(this).property("value")
		clearChart();
		updateRangeChart(selectedOption)
	});
	
	updateRangeChart("usable_battery_size")
		
	</script>

	</body>
	<p style="font-size:10px">All vehicles with under 50km range excluded from data.</p>
	
</html>