
<!DOCTYPE html>
<html>
   <head>
   <meta charset="utf-8">
      <title>Electric Car Range</title>
    </head>
	<script src="https://d3js.org/d3.v4.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <body style = "font-family:verdana;font-size:20px;" id = "tooltipBody">
		<div class="right" style="padding-left:20px;position:relative;font-size:36px;">
		
		    <p>
			 You want your electric car to have...
		    </p>
		</div>
    
	<a href="https://maxahoy.github.io/electricVehicleCompare2021/performance.html";onClick="currentChart = performanceButton();console.log('chartchoice = ' + currentChart);" style="cursor: pointer; cursor: hand; font-size:20px;color:blue;" title="Click me to see the Performance chart">. . . the best Performance</a><br>
	<a style="font-size:20px;color:black;" title = "Click me to see the Range chart">. . .  the longest Range</a><br>
	<a href="https://maxahoy.github.io/electricVehicleCompare2021/charging.html";onClick="currentChart = chargingButton();console.log('chartchoice = ' + currentChart);" style="cursor: pointer; cursor: hand; font-size:20px;color:blue;" title = "Click me to see the Charging chart">  . . . the fastest Charging</a><br>
	<p></p>
	<p>Adjust the battery size and see which EV's have the longest range.</p>
	
	
	<p>Move the slider to change the vehicles shown.
	<input id="rangeSlider" title="What is your minimum range" style="position:relative;top:2px;" type="range" min="0" max="200" step="1">

<output></output>
    </select>
	<p><p>
	
		<svg id="range" width = "2000" height="450">
		</svg>
	<div id="tooltipDiv" style = "font-size:16px;"></div>	
		<script>
	
	
		/*
	##TODO:
Import the json data - done
Build the scatter plot
In the update loop as well
No transitions necessary... but maybe if you feel like it


	*/
	//for development url: https://raw.githack.com/Maxahoy/electricVehicleCompare2021/main/ev-data.json
		//for production: https://rawcdn.githack.com/Maxahoy/electricVehicleCompare2021/d20daec3b06eec3013a8fec48acae39e6c528447/ev-data.json
	var dataURL = "https://rawcdn.githack.com/Maxahoy/electricVehicleCompare2021/d20daec3b06eec3013a8fec48acae39e6c528447/ev-data.json"

	var margin = {top : 20, right: 100, bottom: 100, left: 100},
		width = 800 - margin.left - margin.right,
		height = 450 - margin.top - margin.bottom;
	
	//select the svg for this page	
	var rangeSVG = d3.select("#range")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
	//tooltip (TODO)
	
	//x axis
	/*var x = d3.scaleL()
		.range([0, width])
		.padding(0.03);
	var xAxis = rangeSVG.append("g")  //copied from the performance one...
		.attr("transform", "translate(0," + height + ")")*/
		
		

	var x = d3.scaleLinear()
			.range([0, width]);
		var xAxis = rangeSVG.append("g")
			.attr("class", "X_axis");
	
	//y axis
	var y = d3.scaleLinear()
		.range([height, 0]);
	var yAxis = rangeSVG.append("g")
		.attr("class", "Y_axis");
		
	var tooltip = d3.select("#tooltipDiv")
				.append("div")
				.attr("class", "tooltip")
				.style("background-color", "white")
				.style("border", "solid")
				.style("border-width", "1px")
				.style("border-radius", "5px")
				.style("padding", "10px")
	
	//update method; input is going to be based on a slider in km
	function updateRangeChart(minimumBatterySize) {		
		
		/*var x = d3.scaleLinear()
			.range([minimumBatterySize, width]);
		var xAxis = rangeSVG.append("g")
			.attr("class", "X_axis");*/
			
		d3.json(dataURL, function(data) {
			//console.log(data);
			/*
				The json contains several layers
				
				First, there's the 293 vehicles in the "data" array read in from the json
				
				Also the 40 BRANDS in the "brands" array read in from the json
				
				there's also a "meta" array which just contains an update data and a count of vehicles in the dataset
			*/
			//console.log(data.brands)
			let brands = []
			for (let i = 0; i < data.brands.length; i++) {
				brands.push(data.brands[i].name)
			}
			console.log(brands)
			
			var color = d3.scaleOrdinal().domain(brands)
				.range(d3.schemeSet3);
			
			let vehicles = []
			for (let i = 0; i < data.data.length; i++) {
				range = data.data[i].usable_battery_size * (100 / data.data[i].energy_consumption.average_consumption)
				
				
				if (range > 50 && range < 1000)
				{
					vehicles.push(data.data[i])
				}

			}
			
			//vehicles = data.data
			
			maxRange = 0
			minUsableBattery = 999999
			maxUsableBattery = 0
			minAvgEnergy = 999999
			maxAvgEnergy = 0
			let remainingVehicles = [];
			for (let i = 0; i < vehicles.length; i++) {
				range = vehicles[i].usable_battery_size * (100 / vehicles[i].energy_consumption.average_consumption)
				
				if (range > maxRange) {
					maxRange = range
				}
				
				if (vehicles[i].usable_battery_size < minUsableBattery) {
					minUsableBattery = vehicles[i].usable_battery_size
				}
				
				if (vehicles[i].usable_battery_size > maxUsableBattery && vehicles[i].usable_battery_size < 199) {
					maxUsableBattery = vehicles[i].usable_battery_size
				}
				
				if (minAvgEnergy > vehicles[i].energy_consumption.average_consumption) {
					minAvgEnergy = vehicles[i].energy_consumption.average_consumption
				}
				
				if (maxAvgEnergy < vehicles[i].energy_consumption.average_consumption) {
					maxAvgEnergy = vehicles[i].energy_consumption.average_consumption
				}
				
				if (vehicles[i].usable_battery_size > minimumBatterySize && vehicles[i].usable_battery_size < 199)
				{
					remainingVehicles.push(vehicles[i])
				}


			}
			
			var onClick = function(d) {
				d3.selectAll("." + d.brand)
					//.transition()
					//.duration(200)
					.style("opacity", 1)
				console.log("onclick")
			}
				
			var mouseOver = function(d) {
				tooltip.style("opacity", 1)
				//console.log("mouseover")
			}
			
			var mouseMove = function(d) {
				range = d.usable_battery_size * (100 / d.energy_consumption.average_consumption)
				range = Math.round(range * 1) / 1
				//console.log("mousemove")
				tooltip.style("opacity", 1)
				.style("left", (d3.mouse(this)[0])+"px")
				.style("top", (d3.mouse(this)[1]) + "px")
				.html("<strong>Make:</strong> <span style='color:red'>" + (d.brand).split("_")[0] 
				
				+ "</span><br><strong>Model: </strong> <span style='color:red'>" + d.model	
				+ "</span><br><strong>Trim: </strong> <span style='color:red'>" + d.variant
				+ "</span><br><strong>Estimated Range (km): </strong> <span style='color:red'>" + range
				+ "</span><br><strong>Estimated Range (mi): </strong> <span style='color:red'>" + Math.round((range/1.609))/1
				+ "</span><br><strong>Usable Battery Size (kwH) </strong> <span style='color:red'>" + d.usable_battery_size
				+ "</span><br><strong>Energy Consumption / 100km </strong> <span style='color:red'>" + d.energy_consumption.average_consumption
				
				/* + 
				":</strong> <span style='color:red'>" + 
				d[selectedField]+ "</span>"
				+ "<span><br><strong>EPA Combined Range (miles): </strong> <span style='color:red'>" + d["EPA combined range"]
				+ "</span><br><strong>1/4 mile finishing speed: </strong> <span style='color:red'>" + d["1/4 Mile Speed"] + "</span>"*/)
			}
			
			var mouseLeave = function(d) {
				tooltip.transition()
				.duration(100)
				.style("opacity", 0)
				//console.log("mouseleave")
			}
			
			//console.log("minusable " + minUsableBattery) //5.5
			//console.log("maxusable " + maxUsableBattery) //200
			//console.log("minavg " + minAvgEnergy) //4.5
			//console.log("maxavg " + maxAvgEnergy) //197
			
			//calculate range for all of the vehicles in the vehicles list
			//range (km) = usable_battery_size (kwH) * (100km / avg_energy_consumption (kwH/100km))
			// trust me I worked it out with the power of algebra
			
			//x axis attribute changes; make the x axis go from 0 to the max
			//x.domain([minimumBatterySize, maxUsableBattery])
			x.domain([0, maxUsableBattery])
			xAxis//.transition().duration(500)
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x));
			//TODO: give axis label

			y.domain([0, 600])
			yAxis//.transition().duration(500)
			.call(d3.axisLeft(y));
			
			/*
				I couldn't figure out how to get data to clear out... so instead, I took the lazy way out
				And I just draw a white circle over every dot to match the background, before drawing whichever ones I actually want to see
				
				This draw here basically erases everything.
			*/
			//console.log(rangeSVG)
			
			rangeSVG.append("g")
				.selectAll("dot")
				.data(vehicles)
				.enter()
				.append("circle")//.transition().duration(500)
				.attr("cx", function(d) {/*console.log( "usable battery: " + x(d.usable_battery_size) );*/ return x(d.usable_battery_size); })
				.attr("cy", function(d) {/*console.log( "energy consumption: " + y(d.energy_consumption.average_consumption)); */return y(d.usable_battery_size * (100 / d.energy_consumption.average_consumption));})
				.attr("r", 7)
				.style("fill", "white")
				.style("opacity", 1)
				.style("stroke", "white")
				
			/*
				This draws the vehicle points that I actually want to look at
			*/
			//console.log(remainingVehicles.length)
			rangeSVG.append("g")
				.selectAll("dot")
				.data(remainingVehicles)
				.enter()
				.append("circle")
				.on("mousemove", mouseMove)
				.on("mouseleave", mouseLeave)
				.on("mouseover", mouseOver)
				.on("click", onClick)
				.attr("cx", function(d) {/*console.log( "usable battery: " + x(d.usable_battery_size) );*/ return x(d.usable_battery_size); })
				.attr("cy", function(d) {/*console.log( "energy consumption: " + y(d.energy_consumption.average_consumption)); */return y(d.usable_battery_size * (100 / d.energy_consumption.average_consumption));})
				.attr("r", 7)
				.style("fill", function (d) {return color(d.brand);}).transition().duration(500)
				.style("opacity", 1)
				.style("stroke", "white")
				
			//console.log(remainingVehicles.length)
		
		})
	
	}
	
	d3.select("input[type=range]").on("change", function() {
		var min = d3.select(this).property("value")
		updateRangeChart(min)
	});
	
	updateRangeChart(0,1000)
		
	</script>

	</body>
	<p style="font-size:10px">All vehicles with under 50km range excluded from data.</p>
	
</html>